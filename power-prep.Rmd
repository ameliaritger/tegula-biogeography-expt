---
title: "Preparing MARINe raw data for power analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, error=FALSE)
```

## Load packages
```{r}
library(tidyverse)
library(janitor)
library(here)
library(vegan)
```

# SWATH DATA
## Quick data tidy
```{r}
swath <- read_csv(here("data","amelia_ritger_cbs_ltm_data_20210601-swath.csv")) %>% 
  clean_names() %>% 
    rename("species" = "final_classification",
         "site"="intertidal_sitename") %>%
  select("site","site_code","survey_rep","year","month","transect","location","species","count")

sort(unique(swath$species))
```

## Check out summary data
```{r}
swath_clean <- swath %>% 
  filter(species!="no swath species found") %>% 
  group_by(site, year, species) %>% 
  summarize(tot_sp=sum(count))
```

## Look into some high numbers
```{r}
swath_lol <- swath %>% 
  filter(species!="no swath species found",
         site=="Lompoc Landing",
         year=="2014")

#Confirm with MARINe summary data for swath counts
marine <- read_csv(here("data","amelia_ritger_cbs_summary_2020_1005-swath.csv")) %>% 
  clean_names() %>% 
  filter(intertidal_sitename=="Lompoc Landing",
         year=="2014")
```

Yep, my quick wrangling matches up with the MARINe summarized data 

## Quick visualization 
```{r}
ggplot(swath_clean, aes(fill=species, y=tot_sp, x=year)) + 
  geom_bar(position="fill", stat="identity") +
  facet_wrap(~site)

#Look at it each year
ggplot(swath_clean, aes(fill=species, y=tot_sp, x=site)) + 
  geom_bar(position="fill", stat="identity") +
  facet_wrap(~year)
#+facet_wrap(~site)
```

I want to exclude Cabrillo (it's SO different from the other sites) and compare only years where all three other sites were measured - so 2016, 2018, 2019, and 2020

```{r}
swath_three <- swath_clean %>% 
  filter(site!="Cabrillo III",
         year %in% c(2016, 2018, 2019, 2020))

ggplot(swath_three, aes(fill=species, y=tot_sp, x=site)) + 
  geom_bar(position="fill", stat="identity")

```

### Damn, check out that (lack of diversity)!

# QUADRAT DATA
## Quick data tidy
```{r}
quad <- read_csv(here("data","amelia_ritger_cbs_ltm_data_20210601-quad.csv")) %>% 
  clean_names() %>% 
    rename("species" = "final_classification",
         "site"="intertidal_sitename") %>%
  select("site","survey_rep","year","month","transect","location","zone_code","species","count")
```

## Check out summary data
```{r}
sort(unique(quad$species))

quad_clean <- quad %>% 
  filter(species %in% c("acanthinucella spp","cancer antennarius","cancer spp", "kelletia kelletii", "leptasterias spp","nucella canaliculata","ucella emarginata; nucella ostrina","pachygrapsus crassipes","hemigrapsus nudus","pisaster ochraceus","tegula aureotincta","tegula brunnea","tegula eiseni","tegula funebralis","tegula gallina")) %>% 
  group_by(site, year, species) %>% 
  summarize(tot_sp=sum(count))
```
# In the future (when I have time) - check species list for predators I may have missed

## check it with MARINe summarized data
```{r}
marine <- read_csv(here("data", "amelia_ritger_cbs_summary_2020_1005-quad.csv")) %>% 
  clean_names() %>% 
  filter(intertidal_sitename=="Alegria",
         year=="2001")
```

Yep, looks good

## Plot it up 
```{r}
ggplot(quad_clean, aes(fill=species, y=tot_sp, x=site)) + 
  geom_bar(position="fill", stat="identity") + #facet_wrap(~year)
  scale_x_discrete(limits = c("Bodega", "Lompoc Landing", "Alegria", "Cabrillo III"))

ggsave("figures/composition_site.png")

```

## Run an NMDS on the data to compare community composition across sites
```{r}
#example community-by-species matrix, nmds
set.seed(2)
community_matrix=matrix(
   sample(1:100,300,replace=T),nrow=10,
   dimnames=list(paste("community",1:10,sep=""),paste("sp",1:30,sep="")))

example_NMDS=metaMDS(community_matrix, # Our community-by-species matrix
                     k=2) # The number of reduced dimensions

#do it with my data
quad_matrix_df <- quad %>%
  filter(species %in% c("acanthinucella spp","cancer antennarius","cancer spp", "kelletia kelletii", "leptasterias spp","nucella canaliculata","nucella emarginata; nucella ostrina","pachygrapsus crassipes","hemigrapsus nudus","pisaster ochraceus","tegula aureotincta","tegula brunnea","tegula eiseni","tegula funebralis","tegula gallina")) %>%
  group_by(site, species) %>% 
  summarize(tot_sp=sum(count)) %>% 
  pivot_wider(names_from=species, values_from=tot_sp) %>% 
  replace(is.na(.), 0)

#convert df to matrix for NMDS
quad_matrix <- data.matrix(quad_matrix_df)
rownames(quad_matrix) <- c("Alegria", "Bodega", "Cabrillo III", "Lompoc Landing") #rename matrix row names to sites
quad_matrix <- quad_matrix[,-1] #remove first column

#run the NMDS
quad_nmds <- metaMDS(quad_matrix, k=2) #k is the number of reduced dimensions
quad_nmds

stressplot(quad_nmds)
plot(quad_nmds, type="t")
```

# Run power analysis on only species found at all sites across sites

## Nucella
```{r}
quad_nucella <- quad %>%
  filter(species %in% c("nucella emarginata; nucella ostrina"),
         survey_rep<ifelse(site=="Cabrillo III", 5, 2)) %>% #Cabrillo only counted nucella on the 4th replicate of surveys so make ifelse
  group_by(site) %>% 
  summarize(tot=n(),
            avg=mean(count),
            var=var(count))

nucella_avg <- quad_nucella %>% 
  pull(avg)
nucella_var <- quad_nucella %>% 
  pull(var) %>% 
  mean()
nucella_n <- quad_nucella %>% 
  pull(tot) %>% 
  mean() %>% 
  ceiling() #round up to whole number for simulation
```

Use simulation to run power analysis for comparing nucella across sites
```{r}
n.sim <- 1000         ## number of simulations
mu    <- nucella_avg  ## site means
sigma2<- nucella_var  ## error variance (averaged across all sites) assumption: 7.5
n     <- nucella_n    ## number of observations per site (mean across all years: 31)

n     <- 16
g     <- length(mu) 
group <- factor(rep(LETTERS[1:g], each = n))

results <- numeric(n.sim) ## vector to store results in

for(i in 1:n.sim){
  ## Simulate new response, build data set
  y <- rnorm(n * g, mean = rep(mu, each = n), sd = sqrt(sigma2))
  data <- data.frame(y = y, group = group)
 
  ## Fit one-way ANOVA model
  fit  <- aov(y ~ group, data = data)
  
  ## Extract result of global F-test
  results[i] <- summary(fit)[[1]][1, "Pr(>F)"] < 0.05 ## 1 = reject
}

mean(results) ## proportion of simulation runs that rejected H_0
```


```{r}
group_by(site) %>% 
  summarize(tot_sp=sum(count))

quad_pachy <- quad %>%
  filter(species %in% c("pachygrapsus crassipes")) %>%
  
quad_tegula <- quad %>%
  filter(species %in% c("tegula funebralis"))

pwr.anova.test(k = , n = , f = , sig.level = , power = ) 
```

