---
title: "sensor analysis - third time's the charm"
author: "Amelia Ritger"
date: "12/29/2021"
output: html_document
---

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      messages = FALSE, 
                      error = FALSE,
                      warning = FALSE)

library(tidyverse)
library(janitor)
library(here)
library(lubridate)
library(scales)
library(rvest) #to scrape tide data from the internet
library(reshape) #to ultimately merge BML, LOL, and ALG
library(gt) #create nice table for presentations
library(webshot) #save gt() table, save highcharts to .png files
library(highcharter) #create highchart to interact with data
library(plotly) #create plots with multiple y axes
library(filesstrings) #move plotly figure to proper folder location
```

## Read in the data
```{r}
auto <- read_csv(here("data","sensors", "sensor-data_all_zoe.csv")) %>% 
  clean_names() %>%
  unite("date_time", "date", "time", sep="\ ") %>%
  mutate(date_time=mdy_hms(date_time), #apply lubridate to date/time column
         date=format(date_time, '%m/%d/%Y'), #create only date column
         time=format(date_time, '%H:%M:%S')) %>% #create only time column
  mutate(location=replace(location, location=="lol", "Lompoc Landing"), #rename locations
           location=replace(location, location=="alg", "Alegria"),
           location=replace(location, location=="bml", "Bodega Bay")) %>%
  select(location, sensor, recovery_date, date_time, date, time, temperature, p_h) %>%
  rename(site=location,
         sensor_number=sensor,
         temp_c=temperature)
```

## Plot up the pH
```{r}
#set site order for plotting (legend)
auto$site <- factor(auto$site, levels=c("Alegria", "Lompoc Landing", "Bodega Bay"))

auto_filter <- auto %>%
  filter(p_h < 8.5) %>%
  mutate(removeit = ifelse(site=="Alegria" & date_time<ymd_hms("2021-06-30 23:00:00"), "remove", "keep")) %>%
  filter(removeit=="keep")

ggplot(auto_filter, aes(x=date_time, y=p_h, group=site)) +
  geom_line(aes(color=site), size=0.7) +
  geom_point(aes(color=site), size=0.5) +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  ylab("pH") +
  theme_bw() +
  theme(legend.title=element_blank(),
        axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_text(size=15),
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=15),
        legend.text=element_text(siz=12))

#ggsave(here("figures", "june-sept.png"), height=20, width=40, units="cm")
```

### Plot temp up for good measure
```{r}
ggplot(auto_filter, aes(x=date_time, y=temp_c, group=site)) +
  geom_line(aes(color=site), size=0.7) +
  geom_point(aes(color=site), size=0.5) +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))

#ggsave(here("figures", "sensors","june-sept_temp.png"), height=20, width=40, units="cm")
```

## Add tide cycles!

#### Customize HTML

Sites: 

- Bodega (Bodega%20Harbor%20entrance%2C%20California)
- Lompoc (Point%20Arguello%2C%20California)
- Alegria (Gaviota%2C%20California)

Glen: number of days to extract

Interval:

 - 10 minutes (00%3A10)
 - 15 minutes (00%3A15)
 - 1 hour (01%3A00)

## BML

### Scrape tide data from http://tbone.biol.sc.edu/tide/
```{r}
bml_tide <- read_html("http://tide.arthroinfo.org/tideshow.cgi?tplotdir=horiz;gx=640;gy=240;caltype=ndp;type=mrare;interval=00%3A15;glen=150;units=feet;year=2021;month=05;day=31;hour=09;min=30;tzone=local;d_year=;d_month=01;d_day=01;d_hour=00;d_min=00;ampm24=24;site=Bodega%20Harbor%20entrance%2C%20California") %>%
  html_elements("pre") %>% #select only the date, time, and tide values from the webpage
  html_text2() %>% #convert list to data table
  data.frame() %>% #convert table to data frame
  mutate(date_tide = str_split(., pattern = "\n")) %>% #split into rows by each time point
  unnest(date_tide) %>% #unnest into two columns 
  mutate(date_tide=as.factor(date_tide)) %>% #make column values factors 
  separate(date_tide, into = c("date", "space", "time", "time_zone", "tide"), sep="\\s") %>% #separate the values (separated by spaces) into their own columns
  select(-"space", -".") %>% #remove the "space" (blank space) column and duplicated column created by unnest() 
  unite("time", "time", "time_zone", sep="\ ",) %>% #join together time and time zone
  unite("date_time", "date", "time", sep="\ ") %>% #join together date and time/time zone
  drop_na() %>% #remove final row with NA (not sure why that's even there)
  mutate(date_time=ymd_hm(date_time), #apply lubridate to date/time column
         tide=as.numeric(tide)) #coerce tide values from character to numeric
```
 
### Plot it up 
```{r}
ggplot(bml_tide, aes(x=date_time, y=tide)) +
  geom_line(size=0.7) +
  scale_x_datetime(breaks = scales::date_breaks("2 days"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  ylab("Tide height") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))

#ggsave(here("figures", "bml_tide.png"), height=20, width=40, units="cm")
```

### Extract temp values from HOBO logger, clean up for overlap with BML readings
```{r}
bml_temp <- read_csv(here("data","sensors", "hobo_bml.csv")) %>% 
  filter(row_number()!=1) %>% # remove the first row
  clean_names() %>%
  rename(timestamp=x2,
         temp_hobo_f=x3) %>%
  mutate(date_time=ymd_hms(timestamp), #aapply lubridate to date/time column
         date=format(date_time, '%m/%d/%Y'), #create only date column
         time=format(date_time, '%H:%M:%S'), #create only time column
         temp_hobo_c=((as.numeric(temp_hobo_f)-32)*(5/9))) %>% #convert F to C from HOBO temp data
  select(temp_hobo_c,date_time) %>% #select the only columns that really matter
  filter(date_time <= ymd_hms("2021-10-08 19:00:00"),
         date_time > ymd_hms("2021-06-10 06:15:00")) #remove dates where HOBO was out of field (and first observation when HOBO was deployed, temp is WAY high)
```
  
### Combine the tides with the pH/temp values for BML, plot it up!
```{r}
bml <- auto %>%
  filter(site=="Bodega Bay")

bml_auto_tide <- full_join(bml, bml_tide) %>%
  drop_na(c(tide, p_h)) %>% #whoops, started off collecting data every 10 minutes and then switched to 15 minutes (so account for that by removing pH and tide values that don't overlap)
  distinct(date_time, .keep_all = TRUE) #remove duplicated data (not sure where those came from)

bml_auto <- full_join(bml_auto_tide, bml_temp) %>%
  drop_na(c(temp_c)) %>% #remove hobo measurements taken outside of Durafet measurements
  rename(temp_durafet_c=temp_c) %>% #rename column of temp values taken from Durafet
  mutate(temp_hobo_c=ifelse((date_time==ymd_hms("2021-06-11 08:45:00")), NA, temp_hobo_c)) %>% #some HOBO values are quite odd, replace with NA
  mutate(temp_c=ifelse(is.na(temp_hobo_c==TRUE), temp_durafet_c, temp_hobo_c)) %>% #the HOBO was deployed weeks after the Durafet, so create a new column accounting for this
  filter(date_time <= ymd_hms("2021-10-08 19:00:00")) #remove observations where sensor was not in field
```

Check difference between durafet and hobo temperature readings
```{r}
bml_diff <- bml_auto %>%
  mutate(temp_diff = temp_hobo_c - temp_durafet_c) %>%
  filter(temp_diff > 0,
         temp_diff < 1)

ggplot(data = bml_diff, aes(x=date_time)) +
  geom_line(aes(y=temp_diff)) +
  ylab("temp diff between durafet and hobo") +
  xlab("date")

#ggsave(here("figures", "tempdiff.png"), height=20, width=40, units="cm")
```


```{r}
bml_check <- bml_auto %>%
  pivot_longer(cols=temp_durafet_c:temp_hobo_c,
               names_to = "data",
               values_to = "value")
  
ggplot(bml_check, aes(x=date_time, y=value, group=data)) +
  geom_line(aes(color=data), size=0.7) +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))

#ggsave(here("figures", "bml_pH_temp_tide.png"), height=20, width=40, units="cm")
```

### ID measurements where the sensor was out of the water (initially a tide lower than -0.5, but the "heatwave" on 6/15/21 shows how the temperature spikes disappear after filtering for tide of 0.2)
```{r}
bml_detide <- bml_auto %>%
  mutate(tide_height=tide,
         tide=ifelse(tide_height>=0.21, "high", "low")) %>%
  #filter(tide=="high") %>%
  drop_na(c(p_h)) #drop observations that don't overlap (10 min vs 15 min sampling interval)
  
ggplot(bml_detide, aes(x=date_time)) +
  geom_point(aes(y=tide_height, color=tide), size=0.1) + 
  geom_point(aes(y=temp_hobo_c, color=tide), size=0.1) + # Divide by 10 to get the same range than the temperature
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))

#Create interactive plot to check filtering
library(plotly)
#run this without filtering out low tide values
p <- bml_detide %>%
  #filter(date_time < ymd_hms("2021-06-18 01:00:00")) %>%
         #date_time > ymd_hms("2021-06-20 01:00:00")) %>%
  ggplot(aes(x=date_time)) +
  geom_line(aes(y=tide_height, color=tide)) + 
  geom_point(aes(y=temp_hobo_c, color=tide), size=0.1) + # Divide by 10 to get the same range than the temperature
  theme_bw()

ggplotly(p)
```
         
### Check anomalous points for BML with highchart
```{r}
bml_superfilter <- bml_detide %>%
  filter(date_time > ymd_hms("2021-07-01 01:00:00"),
         date_time < ymd_hms("2021-07-30 23:00:00"))  #7-30 to 8-06 is also interesting

#Looking at the mid July dates, looks like I might need to filter out tides below -0.2? But then if I look at other dates, it's not as bad. -0.4 might actually be a good decision.

y1 <- bml_superfilter$p_h
y2 <- bml_superfilter$temp_c
y3 <- bml_superfilter$tide_height
x <- bml_superfilter$date_time

highchart() %>% 
  hc_add_series(data = y1, dashStyle="solid") %>% 
  hc_add_series(data = y2, yAxis = 1) %>% 
  #hc_add_series(data = y1, yAxis = 2) %>% 
  hc_yAxis_multiples(
     list(lineWidth = 3, lineColor="#009E73", title=list(text="Tide height")),
     #list(lineWidth = 3, lineColor="red", title=list(text="Temperature")),
     list(lineWidth = 3, lineColor="#0072B2", title=list(text="temp_c"))) %>%
    hc_xAxis(title = "Date", categories = x, breaks=10) %>%
  hc_colors(c("#009E73", "#0072B2"))
```

### Let's filter more, now based on anomalous temperature measurements
```{r}
bml_detide_temp <- bml_detide %>%
  filter(!(date_time == ymd_hms("2021-07-28 02:15:00")),
         !(date_time == ymd_hms("2021-08-13 03:00:00")),
         !(date_time == ymd_hms("2021-08-11 21:30:00")))
  
#here were the old filtered dates/times, spikes in July:
  #filter(!(date_time >= ymd_hms("2021-07-10 06:00:00") & date_time <= ymd_hms("2021-07-10 07:30:00")),
         #!(date_time >= ymd_hms("2021-07-21 06:15:00") & date_time <= ymd_hms("2021-07-21 07:15:00")),
         #!(date_time >= ymd_hms("2021-07-22 06:15:00") & date_time <= ymd_hms("2021-07-22 08:00:00")),
         #!(date_time >= ymd_hms("2021-10-10 17:45:00")),
         #!(date_time >= ymd_hms("2021-07-23 07:15:00") & date_time <= ymd_hms("2021-07-23 08:30:00")))

ggplot(bml_detide_temp, aes(x=date_time)) +
  geom_line(aes(y=temp_hobo_c), color="red") + 
  geom_line(aes(y=p_h), color="green") + 
  geom_line(aes(y=tide_height), color="blue") + # Divide by 10 to get the same range than the temperature
  scale_x_datetime(breaks = scales::date_breaks("1 day"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))
```

## LOL 

### Scrape tide data from http://tbone.biol.sc.edu/tide/
```{r}
lol_tide <- read_html("http:///tide.arthroinfo.org/tideshow.cgi?tplotdir=horiz;gx=640;gy=240;caltype=ndp;type=mrare;interval=00%3A15;glen=150;units=feet;year=2021;month=06;day=14;hour=08;min=00;tzone=local;d_year=;d_month=01;d_day=01;d_hour=00;d_min=00;ampm24=24;site=Point%20Arguello%2C%20California") %>%
  html_elements("pre") %>% #select only the date, time, and tide values from the webpage
  html_text2() %>% #convert list to data table
  data.frame() %>% #convert table to data frame
  mutate(date_tide = str_split(., pattern = "\n")) %>% #split into rows by each time point
  unnest(date_tide) %>% #unnest into two columns 
  mutate(date_tide=as.factor(date_tide)) %>% #make column values factors 
  separate(date_tide, into = c("date", "space", "time", "time_zone", "tide"), sep="\\s") %>% #separate the values (separated by spaces) into their own columns
  select(-"space", -".") %>% #remove the "space" (blank space) column and duplicated column created by unnest() 
  unite("time", "time", "time_zone", sep="\ ",) %>% #join together time and time zone
  unite("date_time", "date", "time", sep="\ ") %>% #join together date and time/time zone
  drop_na() %>% #remove final row with NA (not sure why that's even there)
  mutate(date_time=ymd_hm(date_time), #apply lubridate to date/time column
         tide=as.numeric(tide)) #coerce tide values from character to numeric
```

### Plot it up 
```{r}
ggplot(lol_tide, aes(x=date_time, y=tide)) +
  geom_line(size=0.7) +
  scale_x_datetime(breaks = scales::date_breaks("2 days"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  ylab("Tide height") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))

#ggsave(here("figures", "lol_tide.png"), height=20, width=40, units="cm")
```

### Extract temp values from HOBO logger, clean up for overlap with LOL readings
```{r}
lol_temp <- read_csv(here("data","sensors", "hobo_lol.csv")) %>% 
  filter(row_number()!=1) %>% # remove the first row
  clean_names() %>%
  rename(timestamp=x2,
         temp_hobo_f=x3) %>%
  mutate(date_time=ymd_hms(timestamp), #aapply lubridate to date/time column
         date=format(date_time, '%m/%d/%Y'), #create only date column
         time=format(date_time, '%H:%M:%S'), #create only time column
         temp_hobo_c=((as.numeric(temp_hobo_f)-32)*(5/9))) %>% #convert F to C from HOBO temp data
  select(temp_hobo_c,date_time) #select the only columns that really matter
```

### Combine the tides with the pH/temp values for LOL, plot it up!
```{r}
# filter all data for LOL
lol <- auto %>%
  filter(site=="Lompoc Landing") %>%
  distinct(date_time, .keep_all = TRUE) #remove duplicated data (not sure where those came from)

#join HOBO data with Durafet data
lol_all_1 <- full_join(lol, lol_temp) %>%
  drop_na(c(temp_c, p_h)) %>% #remove hobo measurements taken outside of Durafet measurements
  rename(temp_durafet_c=temp_c)
```


```{r}
#Check difference between Durafet and HOBO temperature measurements
lol_temp_diff <- lol_all_1 %>%
  mutate(temp_diff=temp_hobo_c - temp_durafet_c) %>%
  filter(temp_diff > 0,
         temp_diff < 1)

ggplot(data = lol_temp_diff, aes(x=date_time)) +
  geom_line(aes(y=temp_diff)) +
  ylab("temp diff between durafet and hobo") +
  xlab("date")

#ggsave(here("figures", "tempdiff-lol.png"), height=20, width=40, units="cm")
```


```{r}
#Plot it up to check for anomalies
y1 <- lol_temp_diff$temp_durafet_c
y2 <- lol_temp_diff$temp_hobo_c
y3 <- lol_temp_diff$diff
x <- lol_temp_diff$date_time

highchart() %>% 
  hc_add_series(data = y1, dashStyle="solid") %>% 
  hc_add_series(data = y2, yAxis = 1) %>% 
  hc_add_series(data = y3, yAxis = 2) %>%
  hc_yAxis_multiples(
     list(lineWidth = 3, lineColor='#D55E00', title=list(text="durafet")),
     list(lineWidth = 3, lineColor="#009E73", title=list(text="hobo")),
     list(lineWidth = 3, lineColor="#0072B2", title=list(text="diff"))) %>%
    hc_xAxis(title = "Date", categories = x, breaks=10) %>%
  hc_colors(c("#D55E00","#009E73", "#0072B2"))

#Join pH, temp data with tide data
lol_all <- full_join(lol_all_1, lol_tide) %>%
  drop_na(c(tide, p_h)) #%>% #remove unnecessary tide values
  #mutate(temp_c=temp_hobo_c)
```

### Check if anomalous points in durafet vs hobo are due to tide cycle?
```{r}
lol_check <- lol_all %>%
  mutate(diff=temp_durafet_c-temp_hobo_c) %>%
  filter(tide<3.232) #this value was extracted thanks to code later on
  #filter((date_time < ymd_hms("2021--01 01:00:00") & date_time <= ymd_hms("2021-10-22 24:00:00")))

#create a highchart to assess
y1 <- lol_check$temp_durafet_c
y2 <- lol_check$temp_hobo_c
y3 <- lol_check$diff
x <- lol_check$date_time

highchart() %>% 
  hc_add_series(data = y1, dashStyle="solid") %>% 
  hc_add_series(data = y3, yAxis = 1) %>% 
  hc_add_series(data = y3, yAxis = 2) %>%
  hc_yAxis_multiples(
     list(lineWidth = 3, lineColor='#D55E00', title=list(text="durafet")),
     list(lineWidth = 3, lineColor="#009E73", title=list(text="hobo")),
     list(lineWidth = 3, lineColor="#0072B2", title=list(text="diff"))) %>%
    hc_xAxis(title = "Date", categories = x, breaks=10) %>%
  hc_colors(c("#D55E00","#009E73", "#0072B2"))
```

### Anomalous points aside, plot it "all" up
```{r}
lol_plot <- lol_all %>%
  pivot_longer(cols=temp_durafet_c:tide,
               names_to = "data",
               values_to = "value")
  
ggplot(lol_plot, aes(x=date_time, y=value, group=data)) +
  geom_line(aes(color=data), size=0.7) +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))

#ggsave(here("figures", "lol_pH_temp_tide.png"), height=20, width=40, units="cm")
```

### Remove measurements where the sensor pool was disconnected from the ocean (at a tide lower than +0.5, likely higher (determined later on))
```{r}
lol_detide <- lol_all %>%
  mutate(tide_height=tide,
         tide=ifelse(tide_height>=2.85, "high", "low")) #this value was extracted thanks to "peaks" code soon to come
  #filter(tide=="high")

ggplot(lol_detide, aes(x=date_time)) +
  geom_line(aes(y=tide_height), color="red") + 
  geom_line(aes(y=temp_hobo_c), color="blue") +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))
```

### Check the peaks (the peak is where the tide starts coming back in - when the pool is re-connected to the ocean and the temp drops), and ID where they are so I can filter
```{r}
lol_check <- lol_detide %>%
  filter(date_time < ymd_hms("2021-07-30 23:00:00")) %>%
  arrange(date_time) %>% #make sure observations are in order by date/time
  mutate(diff = temp_hobo_c - lag(temp_hobo_c, default = first(temp_hobo_c))) %>% #find difference between two subsequent temp measurements to identify anomalies
  mutate(diff2 = temp_hobo_c - lead(temp_hobo_c, default = first(temp_hobo_c))) #find difference between two subsequent temp measurements to identify anomalies
  #filter(diff < 1 | diff > -1 | diff2 < 1 | diff2 > -1)

#Thank you stas g (https://stats.stackexchange.com/a/164830) for this function
find_peaks <- function (x, m = 3){
    shape <- diff(sign(diff(x, na.pad = FALSE)))
    pks <- sapply(which(shape < 0), FUN = function(i){
       z <- i - m + 1
       z <- ifelse(z > 0, z, 1)
       w <- i + m + 1
       w <- ifelse(w < length(x), w, length(x))
       if(all(x[c(z : i, (i + 2) : w)] <= x[i + 1])) return(i + 1) else return(numeric(0))
    })
     pks <- unlist(pks)
     pks
}

pk <- find_peaks(lol_check$temp_hobo_c, m = 50) #set a high threshold bc we need it...

lol_check_peak <- lol_detide %>%
  #filter(tide=="high") %>%
  filter(date_time < ymd_hms("2021-07-30 23:00:00")) %>%
  arrange(date_time) %>% #make sure observations are in order by date/time
  mutate(diff = temp_hobo_c - lag(temp_hobo_c, default = first(temp_hobo_c))) %>% #find difference between two subsequent temp measurements to identify anomalies
  mutate(diff2 = temp_hobo_c - lead(temp_hobo_c, default = first(temp_hobo_c))) %>% #find difference between two subsequent temp measurements to identify anomalies
  #filter(diff < 1 | diff > -1 | diff2 < 1 | diff2 > -1)
  mutate(peak = ifelse(row_number() %in% c(pk) == TRUE, 1, 0)) #if a row ID matches the row ID found by find_peaks, then call it "1" (if not, "0")

ggplot(lol_check_peak, aes(x=date_time)) +
  geom_line(aes(y=tide_height), color="red") + 
  geom_line(aes(y=temp_hobo_c), color="blue") +
  geom_line(aes(y=diff), color="green") +
  #geom_line(aes(y=diff2), color="orange") +
  geom_point(aes(y=temp_hobo_c, color=ifelse(peak>0, "red", "black"), size=ifelse(peak>0, 2, 0))) + #if it's a peak, color it red and make it big
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90)) +
  scale_color_identity() +
  scale_size_identity() +
  geom_vline(aes(xintercept = date_time), lol_check_peak %>% filter(peak == 1)) + #if it's a peak, draw a vertical line
  scale_y_continuous(breaks = round(seq(min(lol_check_peak$tide_height), max(lol_check_peak$tide_height), by = 0.5),1))

#2.850483 is a good candidate
```

Looks like anything below a 1.5 tide height is definitely disconnected from the ocean

### So now, let's filter based on high tide, differences between consecutive pH measurements
```{r}
lol_detide_temp_ph <- lol_detide %>%
  filter(tide=="high") %>%
  arrange(date_time) %>% #make sure observations are in order by date/time
  mutate(diff3 = p_h - lag(p_h, default = first(p_h))) #doesn't look like pH values jump extraordinarily

#And plot it up 
ggplot(lol_detide_temp_ph, aes(x=date_time)) +
  geom_line(aes(y=p_h), color="#009E73") + 
  geom_line(aes(y=temp_hobo_c), color="#D55E00") + # Divide by 10 to get the same range than the temperature
  geom_line(aes(y=tide_height), color="#0072B2") + # Divide by 10 to get the same range than the temperature
  geom_line(aes(y=diff3), color="green") +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  annotate(geom="text", x=as.POSIXct("2021-09-24 00:01:00"), y=19, hjust=0, label="Temp (C)", color="#D55E00", size=5) +
  annotate(geom="text", x=as.POSIXct("2021-6-14 00:01:00"), y=9, hjust=-0.1, label="pH", color="#009E73", size=5) +
  annotate(geom="text", x=as.POSIXct("2021-6-14 00:01:00"), y=6, hjust=0, label="Tide", color="#0072B2", size=5) +
  xlab("Date & time") +
  ylab("Value") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_text(size=15),
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=15))

#ggsave(here("figures", "lol_detide_tide-temp.png"), height=20, width=40, units="cm")
```

### Plot up these data using a format similar to Li's for the LTER data - welcome, highchart!
```{r}
y1 <- lol_detide_temp_ph$p_h
y2 <- lol_detide_temp_ph$temp_hobo_c
y3 <- lol_detide_temp_ph$tide
x <- lol_detide_temp_ph$date_time

plot <- highchart() %>% 
  hc_add_series(data = y1, dashStyle="solid") %>% 
  hc_add_series(data = y2, yAxis = 1) %>% 
  hc_add_series(data = y3, yAxis = 2) %>%
  hc_yAxis_multiples(
     list(lineWidth = 3, lineColor='#D55E00', title=list(text="pH")),
     list(lineWidth = 3, lineColor="#009E73", title=list(text="Temperature")),
     list(lineWidth = 3, lineColor="#0072B2", title=list(text="Tide cycle"))) %>%
    hc_xAxis(title = "Date", categories = x, breaks=10) %>%
  hc_colors(c("#D55E00","#009E73", "#0072B2"))

#Save the highchart
#htmlwidgets::saveWidget(widget = plot, file = here("figures", "LOL_highchart.html"))
#webshot::webshot(url = here("figures", "LOL_highchart.html"), file = here("figures", "LOL_highchart.png"), delay=3)
```

Well that was a bit of a waste of time

### Use wave data to check tide vs temperature stuff
```{r}
#look at July NOAA NDBC data from Santa Maria buoy 
lol_wave <- read_csv(here("data","sensors", "wave-july2021.csv")) %>% 
  clean_names() %>%
  filter(wvht<99.00) %>%
  mutate(mn=mn+5) %>%
  unite("date", "year", "month", "day", sep="/") %>%
  unite("time", "hr", "mn", sep=":") %>%
  unite("date_time", "date", "time", sep=" ") %>%
  mutate(date_time=ymd_hm(date_time)) #apply lubridate to date and time

#join this with the july sensor df
lol_july <- lol_all %>%
  filter(date_time < ymd_hms("2021-08-01 00:00:00"),
         date_time > ymd_hms("2021-07-01 00:00:00"))

lol_wave_join <- full_join(lol_july, lol_wave) %>%
  fill(wvht, .direction = "updown") %>% #fill in empty wave measurements with previous values before
  distinct(date_time, .keep_all = TRUE) %>% #remove duplicated data (not sure where those came from)
  filter(date_time > ymd_hms("2021-07-20 00:00:00"),
         date_time < ymd_hms("2021-07-25 00:00:00"))

y1 <- lol_wave_join$temp_hobo_c
y2 <- lol_wave_join$wvht
y3 <- lol_wave_join$tide
x <- lol_wave_join$date_time

highchart() %>% 
  hc_add_series(data = y1, dashStyle="solid") %>% 
  hc_add_series(data = y2, yAxis = 1) %>% 
  hc_add_series(data = y3, yAxis = 1) %>%
  hc_yAxis_multiples(
     list(lineWidth = 3, lineColor='#D55E00', title=list(text="Temp")),
     list(lineWidth = 3, lineColor="#009E73", title=list(text="Wave Height")),
     list(lineWidth = 3, lineColor="#0072B2", title=list(text="Tide cycle"))) %>%
    hc_xAxis(title = "Date", categories = x, breaks=10) %>%
  hc_colors(c("#D55E00",
              "#009E73",
              "#0072B2"))

#List of tide height candidates (at these heights, temperature started dropping again):
#2.321 
#2.128 
#2.120
#1.987 
#2.277
#2.587
#2.529
#2.291
#2.315
#2.163
#2.54
#2.72
#2.47
#2.57
#2.43
#2.56
#2.46
#2.68
#2.68
```
The wave data isn't a magic bullet, but it does look like I might be overprocessing the data if I make the tide height as high as 3.0. Based on the July data (especially keeping in mind temperature changes will be most apparent in the middle of the day when the sun is out in full force), I'm going to remove any data below a tide height of 2.0


### Let's move on to continuing to process the data for "out of water"
```{r}
lol_superfilter <- lol_detide %>%
  #filter(tide=="high") %>%
  filter(date_time > ymd_hms("2021-06-10 01:00:00"),
         date_time < ymd_hms("2021-06-20 23:00:00"))

#3.232 looks good, 3.29 is also a solid candidate for tide filtering
#3.03, 2.89
#2.3, 2.68 are also good candidates - I want to make sure I'm not over-filtering

y1 <- lol_superfilter$p_h
y2 <- lol_superfilter$temp_hobo_c
y3 <- lol_superfilter$tide_height
x <- lol_superfilter$date_time

highchart() %>% 
  hc_add_series(data = y2, dashStyle="solid") %>% 
  #hc_add_series(data = y2, yAxis = 1) %>% 
  hc_add_series(data = y1, yAxis = 1) %>%
  hc_yAxis_multiples(
     list(lineWidth = 3, lineColor='#D55E00', title=list(text="pH")),
     #list(lineWidth = 3, lineColor="#009E73", title=list(text="Temp")),
     list(lineWidth = 3, lineColor="#0072B2", title=list(text="Tide cycle"))) %>%
    hc_xAxis(title = "Date", categories = x, breaks=10) %>%
  hc_colors(c("#D55E00",
              "#009E73",
              "#0072B2"))
```

Nevermind it wasn't a waste of time! Highcharts are super useful! Looks like the pool is *definitely* disconnected from the ocean at a tide lower than a +3.0...maybe a +3.02 (but possibly even +3.2 or +3.4)... but I don't want to overfilter the data.

### Check results from various filtering tide heights
```{r}
lol_tide_options <- lol_detide %>%
  mutate(tide_low=ifelse(tide_height>=2.85, "high", "low"),
         tide_med=ifelse(tide_height>=3.03, "high", "low"),
         tide_high=ifelse(tide_height>=3.232, "high", "low")) 

lol_low <- lol_tide_options %>%
  filter(tide_low=="high")

lol_med <- lol_tide_options %>%
  filter(tide_med=="high")

lol_high <- lol_tide_options %>%
  filter(tide_high=="high")

ggplot(lol_tide_options, aes(x=date_time)) +
  geom_line(aes(y=p_h)) +
  geom_line(aes(y=temp_hobo_c)) +
  #geom_line(aes(y=p_h, color=tide_med)) +
  #geom_line(aes(y=p_h, color=tide_high)) +
  #geom_line(aes(y=temp_c), color="blue") +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))

#ggsave(here("figures", "lol_high.png"), height=20, width=40, units="cm")

ph_low <- lol_tide_options %>%
  filter(tide_low=="high") %>%
  #drop_na(c(tide)) %>%
  mutate(threshold = ifelse(p_h<7.8, "below", "above")) %>%
  filter(!is.na(p_h)) %>% #remove the times with anomalous pH readings that were replaced with NA
  group_by(threshold) %>%
  summarize(tot_observations = n()) %>%
  ungroup()

lol_minl <- (min(lol_low$p_h))
lol_maxl <- (max(lol_low$p_h))
lol_medianl <- (median(lol_low$p_h))
lol_meanl <- (mean(lol_low$p_h))
lol_sdl <- (sd(lol_low$p_h))
lol_cvl <- (lol_sdl/lol_meanl)*100 #coefficient of variation

#med tide filtering == higher cv (1.15 vs 1.11), same max, lower mean (7.940 vs 7.946), lower median (7.93 vs 7.94), lower min (7.50 vs 7.43), higher sd (0.092 vs 0.088), higher % low pH (3.49% vs 2.26%)
#low tide filtering == highest cv (1.24), same max, lowest mean (7.93), lowest median (7.927), lowest min (7.28), highest sd (0.098), highest % low pH (4.70 %)
```

### in comparison with other sites, I think I'm overfiltering if I set the tide height for 3.232, so I'll make it as low as I'm comfortable with (the only big change is the min value is now lower than BML, but you can compare with the mean/median for more context)

### Create df for LOL with values above tides of +2.85, and remove (rather, smooth?) anomalous time periods
```{r}
lol_detided <- lol_all %>%
  mutate(tide_height=tide,
         tide=ifelse(tide_height>=2.85, "high", "low")) %>%
  filter(date_time != ymd_hms("2021-09-15 09:15:00"),
         date_time != ymd_hms("2021-07-13 08:00:00"),
         date_time != ymd_hms("2021-08-19 03:30:00")) %>% #remove anomalous points
  drop_na() #remove NA values, i.e. times with tides but without pH values
```

## ALG 

### Scrape tide data from http://tbone.biol.sc.edu/tide/
```{r}
alg_tide <- read_html("http://tide.arthroinfo.org/tideshow.cgi?tplotdir=horiz;gx=640;gy=240;caltype=ndp;type=mrare;interval=00%3A15;glen=150;units=feet;year=2021;month=06;day=12;hour=01;min=00;tzone=local;d_year=;d_month=01;d_day=01;d_hour=00;d_min=00;ampm24=24;site=Gaviota%2C%20California") %>%
  html_elements("pre") %>% #select only the date, time, and tide values from the webpage
  html_text2() %>% #convert list to data table
  data.frame() %>% #convert table to data frame
  mutate(date_tide = str_split(., pattern = "\n")) %>% #split into rows by each time point
  unnest(date_tide) %>% #unnest into two columns 
  mutate(date_tide=as.factor(date_tide)) %>% #make column values factors 
  separate(date_tide, into = c("date", "space", "time", "time_zone", "tide"), sep="\\s") %>% #separate the values (separated by spaces) into their own columns
  select(-"space", -".") %>% #remove the "space" (blank space) column and duplicated column created by unnest() 
  unite("time", "time", "time_zone", sep="\ ",) %>% #join together time and time zone
  unite("date_time", "date", "time", sep="\ ") %>% #join together date and time/time zone
  drop_na() %>% #remove final row with NA (not sure why that's even there)
  mutate(date_time=ymd_hm(date_time), #apply lubridate to date/time column
         tide=as.numeric(tide)) #coerce tide values from character to numeric
```

### Plot it up 
```{r}
ggplot(alg_tide, aes(x=date_time, y=tide)) +
  geom_line(size=0.7) +
  scale_x_datetime(breaks = scales::date_breaks("2 days"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  ylab("Tide height") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))

#ggsave(here("figures", "alg_tide.png"), height=20, width=40, units="cm")
```

### Combine the tides with the pH/temp values for ALG, plot it up!
```{r}
# filter all data for ALG
alg <- auto %>%
  filter(site=="Alegria")

#combine tide data with sensor data
alg_all_1 <- full_join(alg, alg_tide) %>%
  drop_na(c(temp_c)) #remove extra tide measurements

#extract HOBO data
alg_temp <- read_csv(here("data","sensors", "hobo_alg.csv")) %>% 
  filter(row_number()!=1) %>% # remove the first row
  clean_names() %>%
  rename(timestamp=x2,
         temp_hobo_f=x3) %>%
  mutate(date_time=ymd_hms(timestamp), #aapply lubridate to date/time column
         date=format(date_time, '%m/%d/%Y'), #create only date column
         time=format(date_time, '%H:%M:%S'), #create only time column
         temp_hobo_c=((as.numeric(temp_hobo_f)-32)*(5/9))) %>% #convert F to C from HOBO temp data
  select(temp_hobo_c,date_time) #select the only columns that really matter

# Join HOBO data to alegria df
alg_all <- full_join(alg_all_1, alg_temp) %>%
  drop_na(c(temp_c)) %>% #remove hobo measurements taken outside of Durafet measurements
  rename(temp_durafet_c=temp_c) 

alg_plot <- alg_all %>%
  pivot_longer(cols=temp_durafet_c:temp_hobo_c,
               names_to = "data",
               values_to = "value")
  
ggplot(alg_plot, aes(x=date_time, y=value, group=data)) +
  geom_line(aes(color=data), size=0.7) +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))
```


```{r}
#Check difference between Durafet and HOBO temperature measurements
alg_diff <- alg_all %>%
  mutate(temp_diff=temp_hobo_c - temp_durafet_c) %>%
  filter(temp_diff > 0,
         temp_diff < 1.3)

ggplot(data = alg_diff, aes(x=date_time)) +
  geom_line(aes(y=temp_diff)) +
  ylab("temp diff between durafet and hobo") +
  xlab("date")

#ggsave(here("figures", "alg_tempdiff.png"), height=20, width=40, units="cm")
```

### Remove anomalous measurements at beginning and end of deployment (sensor was likely inundated with sand)
```{r}
alg_desand <- alg_all %>%
  filter(date_time > ymd_hms("2021-06-18 01:00:00"), #super weird, but pH looks like it stabilizes at 1AM post sand
         date_time <= ymd_hms("2021-11-07 17:00:00")) %>% #and then here's a period of time at the end of deployment that needs to be removed
  mutate(p_h=ifelse((date_time > ymd_hms("2021-10-23 16:45:00") & date_time < ymd_hms("2021-11-02 10:45:00")), NA, p_h),
         temp_hobo_c=ifelse((date_time > ymd_hms("2021-10-23 16:45:00") & date_time < ymd_hms("2021-11-02 10:45:00")), NA, temp_hobo_c)) %>% #since this is in the middle of the dataset, replace values with "NA" rather than remove entirely (otherwise when plotting, R will fill in the missing space with a straight line)
  distinct(date_time, .keep_all = TRUE)# %>% #remove duplicated data (not sure where those came from)
  #rename(temp_c=temp_hobo_c) #rename temperature column

ggplot(alg_desand, aes(x=date_time, y=p_h)) +
  geom_line(size=0.7) +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90))
```

### Detide ALG data and plot
```{r}
alg_detide <- alg_desand %>%
  mutate(tide_height=tide,
         tide=ifelse(tide_height>=0.97, "high", "low"))
  #filter(tide=="high")

ggplot(alg_detide, aes(x=date_time)) +
  geom_line(aes(y=p_h), color="#009E73") + 
  geom_line(aes(y=temp_hobo_c), color="#D55E00") + # Divide by 10 to get the same range than the temperature
  geom_line(aes(y=tide_height), color="#0072B2") + # Divide by 10 to get the same range than the temperature
  scale_x_datetime(breaks = scales::date_breaks("4 days"), 
                    labels = date_format("%m/%d %H:%m")) +
  annotate(geom="text", x=as.POSIXct("2021-6-18 00:01:00"), y=19, hjust=0, label="Temp (C)", color="#D55E00", size=5) +
  annotate(geom="text", x=as.POSIXct("2021-6-18 00:01:00"), y=10, hjust=-0.1, label="pH", color="#009E73", size=5) +
  annotate(geom="text", x=as.POSIXct("2021-6-18 00:01:00"), y=-1.5, hjust=0, label="Tide", color="#0072B2", size=5) +
  xlab("Date & time") +
  ylab("Value") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_text(size=15),
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=15))

#ggsave(here("figures", "alg_detide.png"), height=20, width=40, units="cm")
```

Tried 0.00, but still seeing steep drop in pH with tide cycle
Tried 0.60, but still seeing steep drop in pH
Tried 0.80, but still seeing some drop in pH
0.90 appears to be OK at not creating massive drop in pH but still having some reasonable cycle

### Check anomalous points and filter by tide height given pH patterns
```{r}
alg_highchart <- alg_detide %>%
  filter(tide=="high") %>%
  filter(date_time > ymd_hms("2021-11-01 01:00:00"),
         date_time < ymd_hms("2021-11-26 23:00:00"))
# filter(tide>=0.9)

y1 <- alg_highchart$p_h
y2 <- alg_highchart$temp_hobo_c
y3 <- alg_highchart$tide_heigh
x <- alg_highchart$date_time

highchart() %>% 
  hc_add_series(data = y1, dashStyle="solid") %>% 
  hc_add_series(data = y2, yAxis = 1) %>% 
  hc_add_series(data = y3, yAxis = 2) %>%
  hc_yAxis_multiples(
     list(lineWidth = 3, lineColor='#D55E00', title=list(text="pH")),
     list(lineWidth = 3, lineColor="#009E73", title=list(text="Temp")),
     list(lineWidth = 3, lineColor="#0072B2", title=list(text="Tide cycle"))) %>%
    hc_xAxis(title = "Date", categories = x) %>%
  hc_colors(c("#D55E00",
              "#009E73", 
              "#0072B2"))
```

These points look fine (and filtering should be easy since the sensor is always connected to the ocean) - but the high chart is suggesting a pattern around 0.00 tide (so let's try removing everything below 0.00... actually, let's try 0.6 since some of those pH values are quite low and consistently dropping at low tide it seems)

There's still some noise at a few dates, let's filter those dates out of the data
### Remove (or smooth?) time periods with a LOT of noise
```{r}
alg_no_noise <- alg_detide %>%
  mutate(p_h=ifelse((date_time > ymd_hms("2021-07-17 11:00:00") & date_time < ymd_hms("2021-07-17 19:30:00")), NA, p_h),
         temp_hobo_c=ifelse((date_time > ymd_hms("2021-07-17 11:00:00") & date_time < ymd_hms("2021-07-17 19:30:00")), NA, temp_hobo_c)) %>% #super noisy section of time for pH (not temp though) in mid July
  mutate(p_h=ifelse((date_time > ymd_hms("2021-09-09 10:15:00") & date_time < ymd_hms("2021-09-09 13:00:00")), NA, p_h),
         temp_hobo_c=ifelse((date_time > ymd_hms("2021-09-09 10:15:00") & date_time < ymd_hms("2021-09-09 13:00:00")), NA, temp_hobo_c)) %>% #super noisy section of time for pH (not temp) in early September
  filter(!(date_time %in% (ymd_hms("2021-06-19 10:15:00",
                                   "2021-06-29 14:15:00",
                                   "2021-06-29 15:30:00",
                                   "2021-06-29 16:15:00",
                                   "2021-06-29 16:30:00",
                                   "2021-06-29 19:00:00",
                                   "2021-06-29 19:15:00",
                                   "2021-06-29 20:45:00",
                                   "2021-06-30 11:30:00",
                                   "2021-06-30 11:45:00",
                                   "2021-06-30 14:15:00",
                                   "2021-06-30 16:15:00",
                                   "2021-06-30 18:45:00",
                                   "2021-06-30 19:15:00",
                                   "2021-07-02 06:15:00",
                                   "2021-07-02 07:45:00",
                                   "2021-07-02 10:45:00",
                                   "2021-07-04 09:45:00",
                                   "2021-07-04 12:00:00",
                                   "2021-07-04 15:15:00",
                                   "2021-10-02 18:15:00",
                                   "2021-10-09 11:15:00",
                                   "2021-10-22 02:30:00",
                                   "2021-10-22 08:15:00",
                                   "2021-10-23 16:30:00")))) #remove individual time points with significant jumps in the wrong direction, identified using highchart

ggplot(alg_no_noise, aes(x=date_time)) +
  geom_line(aes(y=p_h), color="#009E73") + 
  geom_line(aes(y=temp_hobo_c), color="#D55E00") + # Divide by 10 to get the same range than the temperature
  geom_line(aes(y=tide_height), color="#0072B2") + # Divide by 10 to get the same range than the temperature
  scale_x_datetime(breaks = scales::date_breaks("4 days"), 
                    labels = date_format("%m/%d %H:%m")) +
  annotate(geom="text", x=as.POSIXct("2021-6-18 00:01:00"), y=19, hjust=0, label="Temp (C)", color="#D55E00", size=5) +
  annotate(geom="text", x=as.POSIXct("2021-6-18 00:01:00"), y=10, hjust=-0.1, label="pH", color="#009E73", size=5) +
  annotate(geom="text", x=as.POSIXct("2021-6-18 00:01:00"), y=-1.5, hjust=0, label="Tide", color="#0072B2", size=5) +
  xlab("Date & time") +
  ylab("Value") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_text(size=15),
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=15))
```

# Now let's actually plot up a comparison of the pH values across sites
```{r}
bml_detide_temp <- bml_detide_temp %>%
  select(-temp_hobo_c) %>%
  rename(temp_hobo_c=temp_c)

#join all sites into one df (and remove diff columns)
ph_all <- merge_recurse(list(alg_no_noise, lol_detided, bml_detide_temp)) %>%
  mutate(site = factor(site, levels = c("Alegria", "Bodega Bay", "Lompoc Landing"))) %>%
  arrange(site, date_time)

ph_all_detide <- ph_all %>%
  filter(tide=="high")

#set order for sites
ph_all_detide$site <- factor(ph_all_detide$site, levels=c("Lompoc Landing","Alegria","Bodega Bay"))

#set custom color for sites
pal <- c(
  "Alegria" = "#D55E00",
  "Lompoc Landing" = "#009E73", 
  "Bodega Bay" = "#0072B2"
)

ggplot(ph_all_detide, aes(x=date_time, y=p_h, group=site)) +
  geom_line(aes(color=site), size=0.7, alpha=0.8) +
  scale_color_manual(values = pal) + #color lines by custom site color palette
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  #xlab("Date and time") +
  ylab("pH") +
  theme_bw() +
  theme(axis.text.x=element_blank(), 
        #element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_blank(),
        #element_text(size=15),
        axis.text.y=element_text(size=12),
        #axis.ticks.x=element_blank(),
        axis.title.y=element_text(size=15),
        legend.position = "none")

#ggsave(here("figures", "sensors", "ph_all_detide_final.png"), height=20, width=40, units="cm")

# For presentations, highlight one line at a time per site
#BML focal
ph_all_detide$site <- factor(ph_all_detide$site, levels=c("Lompoc Landing","Alegria","Bodega Bay"))

ggplot(ph_all_detide, aes(x=date_time, y=p_h, group=site)) +
  geom_line(aes(color=site, alpha=site), size=0.7) +
  scale_color_manual(values = pal) + #color lines by custom site color palette
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  ylab("pH") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_text(size=15),
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=15),
        legend.position = "none") +
  scale_alpha_manual(values=c(0.5,0.5,1))

#ggsave(here("figures", "sensors", "ph_bml_final.png"), height=20, width=40, units="cm")

#LOL focal
ph_all_detide$site <- factor(ph_all_detide$site, levels=c("Alegria","Bodega Bay", "Lompoc Landing"))

ggplot(ph_all_detide, aes(x=date_time, y=p_h, group=site)) +
  geom_line(aes(color=site, alpha=site), size=0.7) +
  scale_color_manual(values = pal) + #color lines by custom site color palette
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  ylab("pH") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_text(size=15),
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=15),
        legend.position = "none") +
  scale_alpha_manual(values=c(0.5,0.5,1))

#ggsave(here("figures", "sensors", "ph_lol_final.png"), height=20, width=40, units="cm")

#ALG focal
ph_all_detide$site <- factor(ph_all_detide$site, levels=c("Lompoc Landing","Bodega Bay", "Alegria"))

ggplot(ph_all_detide, aes(x=date_time, y=p_h, group=site)) +
  geom_line(aes(color=site, alpha=site), size=0.7) +
  scale_color_manual(values = pal) + #color lines by custom site color palette
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date time") +
  ylab("pH") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_text(size=15),
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=15),
        legend.position = "none") +
  scale_alpha_manual(values=c(0.5,0.5,1))

#ggsave(here("figures", "sensors", "ph_alg_final.png"), height=20, width=40, units="cm")

# Save the "final" df to a .csv file
write.csv(ph_all, here("data", "sensors", "ph_clean_final.csv"), row.names = FALSE)
#write.csv(ph_all_detide, here("data", "sensors", "ph_detide_final.csv"), row.names = FALSE)
```

# Let's also compare temperature across sites
```{r}
#add site identity before joining
bml_temp_join <- bml_detide_temp %>%
  select(date_time, temp_hobo_c, p_h, tide) %>%
  mutate(site = "Bodega Bay")

lol_temp_join <- lol_detided %>%
  select(date_time, temp_hobo_c, p_h, tide) %>%
  mutate(site = "Lompoc Landing")

alg_join <- alg_no_noise %>%
  select(date_time, temp_hobo_c, p_h, tide) %>%
  mutate(site = "Alegria")

#join these all together into one df
temp_all <- merge_recurse(list(bml_temp_join, lol_temp_join, alg_join)) %>%
    filter(tide=="high")

#set order for sites
temp_all$site <- factor(temp_all$site, levels=c("Lompoc Landing","Alegria","Bodega Bay"))

#set custom color for sites
pal <- c(
  "Alegria" = "#D55E00",
  "Lompoc Landing" = "#009E73", 
  "Bodega Bay" = "#0072B2"
)

ggplot(temp_all, aes(x=date_time, y=temp_hobo_c, group=site)) +
  geom_line(aes(color=site), size=0.7, alpha=0.8) +
  scale_color_manual(values = pal) + #color lines by custom site color palette
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  xlab("Date and time") +
  ylab("Temperature") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=12),
        axis.title.x=element_text(size=15),
        axis.text.y=element_text(size=12),
        axis.title.y=element_text(size=15),
        legend.position = "none")

#ggsave(here("figures", "sensors", "temp_all_final.png"), height=20, width=40, units="cm")
```

# Let's try to combine pH and temperature plots into one grid

```{r}
#first, save it
#ggsave(here("figures", "temp_ph.pdf"), arrangeGrob(ph_plot, temp_plot), height=20, width=40, units="cm")

#doesn't look great, so let's try facet_wrap style

all <- temp_all %>%
  filter(tide=="high") %>%
  select(-tide) %>%
  relocate(site, date_time, temp_hobo_c, p_h) %>%
  rename(Site=site) %>%
  pivot_longer(cols=temp_hobo_c:p_h,
               names_to = "group",
               values_to = "value")

#set order for sites
all$Site <- factor(all$Site, levels=c("Lompoc Landing","Alegria","Bodega Bay"))

#set custom color for sites
pal <- c(
  "Alegria" = "#D55E00",
  "Lompoc Landing" = "#009E73", 
  "Bodega Bay" = "#0072B2"
)

ggplot(all, aes(x=date_time, y=value, group=group)) +
  geom_line(aes(color=Site), size=0.7, alpha=0.7) +
  scale_color_manual(values = pal) + #color lines by custom site color palette
  #geom_point(aes(color=group), size=0.5) +
  scale_x_datetime(breaks = scales::date_breaks("1 week"), 
                    labels = date_format("%m/%d %H:%m")) +
  facet_grid(group ~ ., #facet wrap to create one panel for pH and one for temp
             scales = "free_y",
             switch="both",
             labeller = as_labeller(c(temp_c = "Temperature (C)", p_h = "pH"))) + #customize strip labels
  xlab("Date and time") +
  ylab(NULL) + #remove "Value" from Y axis label
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=22),
        axis.title.x=element_text(size=30),
        axis.text.y=element_text(size=22),
        legend.text=element_text(size=22),
        legend.title = element_blank(),
        #element_text(size=25),
        legend.position = c(0.92,0.95), #customize legend position on plot
        #legend.key.size = unit(4,"line"),
        #legend.key.height = unit(1,"cm"),
        strip.background = element_blank(), #remove strip background from facet_grid
        strip.text.y = element_text(size = 30),
        strip.placement = "outside") + #place the strip outside of the plot
  guides(colour = guide_legend(override.aes = list(size=5, alpha = 1)))

#ggsave(here("figures", "sensors", "temp_all_facet_final.png"), height=50, width=60, units="cm")
```

Now, for some "Chan et al 2017" style analyses

# Look at the frequency of pH values below 7.8 
```{r}
ph_7.8 <- ph_all %>%
  filter(tide=="high") %>%
  filter(date_time > ymd_hms("2021-06-18 01:00:00"),
         date_time < ymd_hms("2021-10-08 23:45:00")) %>% #only select dates where all sensors were deployed (6/18 until 10/08)
  #drop_na(c(tide)) %>%
  mutate(threshold = ifelse(p_h<7.8, "below", "above")) %>%
  filter(!is.na(p_h)) %>% #remove the times with anomalous pH readings that were replaced with NA
  group_by(site, threshold) %>%
  summarize(tot_observations = n()) %>%
  ungroup()
  #add_row(site="Alegria", threshold="below", tot_observations=0) #add this row because Alegria has 0 observations below 7.8 (for now...)

#Get total number of observations - use double square brackets because it's a tibble
alg_n <- ph_7.8[[1,3]] + ph_7.8[[2,3]]
lol_n <- ph_7.8[[3,3]] + ph_7.8[[4,3]]
bml_n <- ph_7.8[[5,3]] + ph_7.8[[6,3]]

#Get frequency of pH values below 7.8
alg_7.8 <- ph_7.8[[2,3]]/alg_n
lol_7.8 <- ph_7.8[[4,3]]/lol_n
bml_7.8 <- ph_7.8[[6,3]]/bml_n
```

# Create a nice table directly comparing conditions between sites
```{r}
# Create de-tided dfs, select only times when all sensors where out at all locations (6/18 until 10/08)
alg_table <- alg_no_noise %>%
  filter(tide=="high") %>%
  filter(date_time > ymd_hms("2021-06-18 01:00:00"),
         date_time < ymd_hms("2021-10-08 23:45:00")) %>%
  filter(!is.na(p_h)) #create df for ALG without NA values

lol_table <- lol_detided %>%
    filter(tide=="high") %>%
  filter(date_time > ymd_hms("2021-06-18 01:00:00"),
         date_time < ymd_hms("2021-10-08 23:45:00"))

bml_table <- bml_detide_temp %>%
    filter(tide=="high") %>%
  filter(date_time > ymd_hms("2021-06-18 01:00:00"),
         date_time < ymd_hms("2021-10-08 23:45:00"))
  
# Calculate min, max, average pH values for each site
alg_min <- (min(alg_table$p_h))
alg_max <- (max(alg_table$p_h))
alg_median <- (median(alg_table$p_h))
alg_mean <- (mean(alg_table$p_h))
alg_sd <- (sd(alg_table$p_h))
alg_cv <- (alg_sd/alg_mean)*100 #coefficient of variation

lol_min <- (min(lol_table$p_h))
lol_max <- (max(lol_table$p_h))
lol_median <- (median(lol_table$p_h))
lol_mean <- (mean(lol_table$p_h))
lol_sd <- (sd(lol_table$p_h))
lol_cv <- (lol_sd/lol_mean)*100 #coefficient of variation

bml_min <- (min(bml_table$p_h))
bml_max <- (max(bml_table$p_h))
bml_median <- (median(bml_table$p_h))
bml_mean <- (mean(bml_table$p_h))
bml_sd <- (sd(bml_table$p_h))
bml_cv <- (bml_sd/bml_mean)*100 #coefficient of variation

ph_table <- tribble(
  ~"Site", ~"Min pH", ~"Max pH", ~"Median pH",  ~"CV", ~"< 7.8", 
  "Bodega Marine Lab", bml_min, bml_max, bml_median, bml_cv, bml_7.8,
  "Lompoc Landing", lol_min, lol_max, lol_median, lol_cv, lol_7.8,
  "Alegria", alg_min, alg_max, alg_median, alg_cv, alg_7.8) 

ph_table %>%
  gt() %>%
  fmt_number(
  columns = c("Min pH":"Median pH"),
  rows = everything(),
  decimals = 2) %>%
  data_color(
    columns = c("Site"),
    colors = scales::col_factor( # <- bc it's a factor
      palette = c("#D55E00","#0072B2","#009E73"),
      domain = c("Bodega Marine Lab", "Lompoc Landing", "Alegria"))) %>%
  gtsave(here("figures", "sensors", "table_ph_final.png"))

# Calculate min, max, average temp values for each site
alg_min <- (min(alg_table$temp_c))
alg_max <- (max(alg_table$temp_c))
alg_median <- (median(alg_table$temp_c))
alg_mean <- (mean(alg_table$temp_c))
alg_sd <- (sd(alg_table$temp_c))
alg_cv <- (alg_sd/alg_mean)*100 #coefficient of variation

lol_min <- (min(lol_table$temp_c))
lol_max <- (max(lol_table$temp_c))
lol_median <- (median(lol_table$temp_c))
lol_mean <- (mean(lol_table$temp_c))
lol_sd <- (sd(lol_table$temp_c))
lol_cv <- (lol_sd/lol_mean)*100 #coefficient of variation

bml_min <- (min(bml_table$temp_c))
bml_max <- (max(bml_table$temp_c))
bml_median <- (median(bml_table$temp_c))
bml_mean <- (mean(bml_table$temp_c))
bml_sd <- (sd(bml_table$temp_c))
bml_cv <- (bml_sd/bml_mean)*100 #coefficient of variation

temp_table <- tribble(
  ~"Site", ~"Min temp", ~"Max temp", ~"Median temp",  ~"CV", 
  "Bodega Marine Lab", bml_min, bml_max, bml_median, bml_cv,
  "Lompoc Landing", lol_min, lol_max, lol_median, lol_cv,
  "Alegria", alg_min, alg_max, alg_median, alg_cv) 

temp_table %>%
  gt() %>%
  fmt_number(
  columns = c("Min temp":"Median temp"),
  rows = everything(),
  decimals = 2) %>%
  data_color(
    columns = c("Site"),
    colors = scales::col_factor( # <- bc it's a factor
      palette = c("#D55E00","#0072B2","#009E73"),
      domain = c("Bodega Marine Lab", "Lompoc Landing", "Alegria"))) %>%
  gtsave(here("figures", "sensors", "table_temp_final.png"))
```

# Summary (what I did)

At BML, sampling interval started at every 10 minutes and then switched to 15 minutes for all sites

Filtering for tide heights based on temp/pH patterns
- All points at ALG were removed at tide heights below 0.97
- All points at LOL were removed at tide heights below 2.85 (3.232 was also a good option, but I don't want to remove more values than need be... ask about this) 
- All points at BML were removed at tide heights below 0.21

Removed additional anomalous time points (noise or major jumps, especially in wrong direction)
- 3 from BML
- 3 from LOL
- At ALG: All data collected before 06/18/2021, between 10/23/2021 and 11/02/2021, plus 25 additional points and a few hours on two dates

# Next: zoom in on LOL as an example of pH variation within tidepool
### Create df - use this for "lol-analysis.Rmd"
```{r}
lol_cycle <- lol_detided %>%
  select(-date, -time, -site) %>%
  relocate(date_time, recovery_date, sensor_number, tide_height, tide, temp_c, temp_durafet_c, p_h)

# Save the "final" df to a .csv file
write.csv(lol_cycle, here("data", "sensors", "lol_all_final.csv"), row.names = FALSE)
```


Next steps:
Am I still overfiltering LOL data? Should I lower it to 2.0 tide?


# Harley and Helmuth filtering - 3C over 20 minutes (9/4C over 15 minutes)
# Collect wave data

## Standard format: 
## "https://www.ndbc.noaa.gov/view_text_file.php?filename=XXXXXXXXXX.txt.gz&dir=data/stdmet/XXX/"

## BML: Station 46214 - Point Reyes, CA (029)
### June: 4621462021   /Jun/
### July: 4621472021   /Jul/

## LOL: Station 46011 (LLNR 215) - SANTA MARIA
### June: 4601162021  /Jun/
### July: 4601172021  /Jul/

## ALG: Station 46054 (LLNR 198.1) - WEST SANTA BARBARA
### June: 4605462021  /Jun/
### July: 4605472021 /Jul/

#function to download wave height data
```{r}
wave_function <- function(station_code, input_month){
  month_str <- ifelse(input_month==5, "May/", 
                      ifelse(input_month==6, "Jun/",
                             ifelse(input_month==7, "Jul/",
                                    ifelse(input_month==8, "Aug/",
                                           ifelse(input_month==9, "Sep/",
                                                  ifelse(input_month=="a", "Oct/", "Nov/"))))))
  
  wave_data <- read.delim(paste0("https://www.ndbc.noaa.gov/view_text_file.php?filename=", station_code, input_month, "2021.txt.gz&dir=data/stdmet/", month_str), sep = "") %>%
  slice(-1) %>%
  mutate(across(where(is.character), as.numeric)) %>%
    clean_names() %>%
    select(1:5, 9) %>%
    rename(year = 1,
           month = 2,
           day = 3,
           hr = 4,
           min = 5,
           wvht = 6) %>%
    filter(wvht<99.00) %>%
    #mutate_all(funs(as.numeric(as.numeric(.)))) %>%
    mutate(minute_else=ifelse((min+4) %% 10 == 0, min+4, min-10), #if min+4 is divisible by 10, add 4 (if not, subtract 10)
           hr=ifelse(minute_else==60, hr+1, hr), #if minute = 60, add 1 hour
           minute_zero=ifelse(minute_else==60, "00", minute_else)) %>% #if minute = 60, set minutes to 00
    unite("date", "year", "month", "day", sep="/") %>%
    unite("time", "hr", "minute_zero", sep=":") %>%
    unite("date_time", "date", "time", sep=" ") %>%
    mutate(date_time=lubridate::ymd_hm(date_time)) %>%
    mutate(station=ifelse(station_code==46214, "Bodega Bay", 
                          ifelse(station_code==46011, "Lompoc Landing", "Alegria")))
}


# mutate(across(where(is.character), as.numeric)) %>%
#     clean_names() %>%
#     select(1:5, 9) %>%
#     rename(year = 1,
#            month = 2,
#            day = 3,
#            hr = 4,
#            min = 5,
#            wvht = 6) %>%
#     filter(wvht<99.00) %>%
#     mutate(test=ifelse(year==2021, min+4, 3),
#            hr=ifelse(test==60, hr+1, hr),
#            minute_new=ifelse(test==60, "00", test)) %>%
#   
  
#check to make sure function works
does_it_work_lol <- wave_function(46011, 6)
does_it_work_bml <- wave_function(46214, 6)
does_it_work_alg <- wave_function(46054, 6)
```

#loop to download wave height data
```{r}
heres_a_list <- list(list()) #create empty list

stations <- c(46214, 46011, 46054) #identify stations of interest
months <- c(seq(5, 9, by=1), "a", "b") #identify months of interest (a and b are oct/nov)

for(i in seq_along(stations)){
  for(j in seq_along(months)){
  #loop for a single station across months
  wave_data <- wave_function(stations[i], months[j]) #run wave_function
  heres_a_list[[j]] <- wave_data #add the results of wave_function to a list
  print(j) #confirm it worked
  }
  
  #loop across stations
  df_loop <- do.call(rbind.data.frame, heres_a_list) #turn j loop into dataframe
  datafile <- read_csv(here("data", "sensors", "wave_data_2021.csv")) #read in shell datafile (to be constantly updated - this should start off as a blank df with only headers, unless you want to add new data)
  out = rbind(datafile, df_loop) #merge j loop df with shell datafile
  write.csv(out, here("data", "sensors", "wave_data_2021.csv"), row.names = FALSE) #overwrite shell datafile
  print(i) #confirm it worked
}

wave_data <- read_csv(here("data", "sensors", "wave_data_2021.csv"))
```

#Add in wave height 

## for BML
```{r}
#Identify points where temperature drop was at least 3C over 20 minutes
bml_hh <- bml_auto %>%
  arrange(date_time) %>%
  mutate(tide_height=tide,
         diff=temp_c-lag(temp_c, default = first(temp_c)), #find difference between temp now and temp before
         im_event=ifelse(diff<=(-9/4), #identify immersion events
                         ifelse(is.na(temp_hobo_c==TRUE),"no_3C_drop", "3C+drop"), "no_3C_drop")) #ignore times where temp drop was bc switching from hobo to durafet

# Add in wave height
bml_wave <- read_csv(here("data","sensors", "wave_data_2021.csv")) %>%
  filter(station=="Bodega Bay")

bml_wave_sum <- bml_wave %>%
  group_by(wvht) %>%
  summarize(n=n())
  
bml_hh_wvht <- full_join(bml_wave, bml_hh) %>%
  arrange(date_time) %>% #make sure observations are in order by date/time
  fill(wvht, .direction = "down") %>% #fill in empty wave measurements with previous values before
  filter(!is.na(p_h)) %>% #create df without NA values (i.e. where wave data doesn't also have sensor data)
  select(site, date_time, time, temp_c, p_h, tide_height, wvht, diff, im_event) #only keep columns of interest
  #filter(date_time <= ymd_hms("2021-06-14 01:00:00"),
         #date_time >= ymd_hms("2021-06-12 01:00:00"))

#check to make sure no obvious errors in df
bml_hh_wvht_sum <- bml_hh_wvht %>%
  group_by(wvht) %>%
  summarize(n=n())

ggplot(bml_hh_wvht, aes(x=wvht)) +
  geom_histogram()

#consider tides, time of day...
bml_hh_wvht_tide <- bml_hh_wvht %>%
    mutate(time_lub=hms(time)) %>% #apply lubridate to time
  filter(tide_height>=-0.1, #remove tides I know are too low
         tide_height<=0.5) %>% #remove tides I know are too high
  filter(hour(time_lub)>04, #remove times before sunrise
         #hour(time_lub)>09, #only look at hottest part of day...
         #hour(time_lub)<17, #only look at hottest part of day...
         hour(time_lub)<21) %>% #remove times after sunset
    mutate(tod=ifelse(hour(time_lub)>09 & hour(time_lub)<17, "midday", "crepuscular"))


#plot up waveheight and temp
ggplot(bml_hh_wvht_tide, aes(x=date_time)) +
  geom_point(aes(y=temp_c, color=im_event), size=1) +
  geom_point(aes(y=wvht, color=im_event), size=0.5) +
  geom_vline(aes(xintercept=date_time),
             data=. %>%
               filter(im_event=="3C+drop"))

bml_hh_wvht_tide$im_event <- factor(bml_hh_wvht_tide$im_event, levels=c("no_3C_drop", "3C+drop"))

#plot up wvht against tide height 
ggplot(bml_hh_wvht_tide, aes(x=wvht, y=tide_height, group=im_event)) +
  geom_point(aes(color=tod, size=im_event)) +
  geom_point(data=bml_hh_wvht_tide[bml_hh_wvht_tide$im_event=="3C+drop",],
             pch=21, fill=NA, size=5, colour="black", stroke=1) +
  guides(size = FALSE) +
  labs(x = "wave height", y = "tide height", color = "time of day")

#ggsave(here("figures", "wave-bml.png"), height=20, width=30, units="cm")
```
 
Well, this doesn't make much sense. There isn't a clear waveheight that I can filter, given there are only 4 instances of 3C drops in the middle of the day (between 10am and 5pm) when the tide was going out/coming in (between -0.1 and 0.5). 

So let's try it now for LOL...

## for LOL
```{r}
#Identify points where temperature drop was at least 3C over 20 minutes
lol_hh <- lol_detide %>%
  filter(date_time<ymd_hms("2021-10-08 18:15:00")) %>% #remove last data point, bc weird temp drop
  arrange(date_time) %>%
  mutate(diff=temp_c-lag(temp_c, default = first(temp_c)), #find difference between temp now and temp before
         im_event=ifelse(diff<=(-9/4), #identify immersion events
                         ifelse(is.na(temp_hobo_c==TRUE),"no_3C_drop", "3C+drop"), "no_3C_drop")) #ignore times where temp drop was bc switching from hobo to durafet

# Add in wave height
lol_wave <- read_csv(here("data","sensors", "wave_data_2021.csv")) %>%
  filter(station=="Lompoc Landing")

lol_hh_wvht <- full_join(lol_wave, lol_hh) %>%
  arrange(date_time) %>% #make sure observations are in order by date/time
  fill(wvht, .direction = "down") %>% #fill in empty wave measurements with previous values before
  filter(!is.na(p_h)) %>% #create df without NA values (i.e. where wave data doesn't also have sensor data)
  select(site, date_time, time, temp_c, p_h, tide_height, wvht, diff, im_event) #only keep columns of interest
  #filter(date_time <= ymd_hms("2021-06-14 01:00:00"),
         #date_time >= ymd_hms("2021-06-12 01:00:00"))

#check to make sure no crazy wvht frequencies
lol_wave_sum <- lol_hh_wvht %>%
  group_by(wvht) %>%
  summarize(n=n())

#plot frequencies
ggplot(lol_wave_sum, aes(x=wvht)) +
  geom_histogram()

#plot up basic waveheight, temp 
ggplot(lol_hh_wvht, aes(x=date_time)) +
  geom_point(aes(y=temp_c, color=im_event), size=1) +
  geom_point(aes(y=wvht, color=im_event), size=0.5)

#consider tides, time of day...
lol_hh_wvht_tide <- lol_hh_wvht %>%
  mutate(time_lub=hms(time)) %>% #apply lubridate to time
  filter(tide_height>=1.4, #remove tides I know are too low
         tide_height<=3.5) %>% #remove tides I know are too high
  filter(hour(time_lub)>04, #remove times before sunrise
         #hour(time_lub)>09, #only look at hottest part of day...
         #hour(time_lub)<17, #only look at hottest part of day...
         hour(time_lub)<21) %>% #remove times after sunset
  mutate(tod=ifelse(hour(time_lub)>09 & hour(time_lub)<17, "midday", "crepuscular")) #%>%
  #filter(wvht<3.5)

#plot up waveheight and temp
ggplot(lol_hh_wvht_tide, aes(x=date_time)) +
  geom_point(aes(y=temp_c, color=im_event), size=1) +
  geom_point(aes(y=wvht, color=im_event), size=0.5) +
  geom_vline(aes(xintercept=date_time),
             data=. %>%
               filter(im_event=="3C+drop"))

lol_hh_wvht_tide$im_event <- factor(lol_hh_wvht_tide$im_event, levels=c("no_3C_drop", "3C+drop"))

#plot up wvht against tide height 
ggplot(lol_hh_wvht_tide, aes(x=wvht, y=tide_height, group=im_event)) +
  geom_point(aes(color=tod, size=im_event)) +
  geom_point(data=lol_hh_wvht_tide[lol_hh_wvht_tide$im_event=="3C+drop",],
             pch=21, fill=NA, size=5, colour="black", stroke=1) +
  guides(size = FALSE) +
  labs(x = "wave height", y = "tide height", color = "time of day")

#ggsave(here("figures", "wave-lol_1.4.png"), height=20, width=30, units="cm")
```
When tide is above 3.0, 3C drops are exclusively midday

### Try it with ALL obvious temperature drops, to ID wave heights and tide heights of interest
```{r}
lol_wvht_exp <- lol_hh_wvht %>%
  arrange(date_time) %>%
  mutate(im_event_2c=ifelse(diff<=(-3/2), #identify immersion events
                         ifelse(is.na(temp_c==TRUE),"no_C_drop", "C_drop"), "no_C_drop"),
         im_event_1c=ifelse(diff<=(-3/4), #identify immersion events
                         ifelse(is.na(temp_c==TRUE),"no_C_drop", "C_drop"), "no_C_drop"),
         im_event_0.8c=ifelse(diff<=(-0.6), #identify immersion events
                         ifelse(is.na(temp_c==TRUE),"no_C_drop", "C_drop"), "no_C_drop"),
         im_event_0.6c=ifelse(diff<=(-0.45), #identify immersion events
                         ifelse(is.na(temp_c==TRUE),"no_C_drop", "C_drop"), "no_C_drop")) %>% #ignore times where temp drop was bc switching from hobo to durafet
  #filter(date_time <= ymd_hms("2021-11-10 19:00:00"),
  #       date_time > ymd_hms("2021-10-01 06:15:00")) %>%
  mutate(im_event_test=ifelse(lag(im_event_0.6c, default = first(im_event_0.6c))=="C_drop", "yes", "no"),
         im_event_fil=ifelse(im_event_test=="no" & im_event_0.6c=="C_drop", "first_drop", "not"),
         wvht_outlier=ifelse(im_event_fil=="first_drop" & tide_height<0, "outlier", "no biggie")) %>%
  mutate(time_lub=hms(time), #apply lubridate to time
         hour_fil=ifelse(hour(time_lub)>04 & hour(time_lub)<21, "daytime", "nighttime"))%>%
  filter(hour_fil=="daytime")

view(lol_wvht_exp)

ggplot(lol_wvht_exp, aes(x=date_time)) +
  geom_point(aes(y=tide_height, color=im_event_fil, size=wvht_outlier)) + 
  geom_point(aes(y=temp_c, color=im_event_fil, size=wvht_outlier)) +
  theme_bw()

lol_hh_fil <- lol_wvht_exp %>%
  filter(im_event_fil=="first_drop")

view(lol_hh_fil)

ggplot(lol_hh_fil, aes(x=date_time)) +
  geom_point(aes(y=tide_height), color="green", size=0.5) + 
  geom_point(aes(y=wvht), color="blue", size=0.5) +
  theme_bw()

ggplot(lol_hh_fil, aes(x=tide_height)) +
  geom_histogram()

ggplot(lol_hh_fil, aes(x=tide_height, y=wvht))+
  geom_point() +
  labs(x="Tide height", y="Wave height")

#ggsave(here("figures", "sensors", "0.6_drop.png"), height=20, width=40, units="cm")
```



## for ALG
```{r}
#Identify points where temperature drop was at least 3C over 20 minutes
alg_hh <- alg_desand %>%
  arrange(date_time) %>%
  mutate(diff=temp_c-lag(temp_c, default = first(temp_c)), #find difference between temp now and temp before
         im_event=ifelse(diff<=(-9/4), #identify immersion events
                         ifelse(is.na(temp_hobo_c==TRUE),"no_3C_drop", "3C+drop"), "no_3C_drop")) #ignore times where temp drop was bc switching from hobo to durafet

# Add in wave height
alg_wave <- read_csv(here("data","sensors", "wave_data_2021.csv")) %>%
  filter(station=="Alegria")

alg_hh_wvht <- full_join(alg_wave, alg_hh) %>%
  rename(tide_height=tide) %>%
  arrange(date_time) %>% #make sure observations are in order by date/time
  fill(wvht, .direction = "down") %>% #fill in empty wave measurements with previous values before
  filter(!is.na(p_h)) %>% #create df without NA values (i.e. where wave data doesn't also have sensor data)
  select(site, date_time, time, temp_c, p_h, tide_height, wvht, diff, im_event) #only keep columns of interest

#check to make sure no crazy wvht frequencies
alg_wave_sum <- alg_hh_wvht %>%
  group_by(wvht) %>%
  summarize(n=n())

#plot frequencies
ggplot(alg_wave_sum, aes(x=wvht)) +
  geom_histogram()

#plot up basic waveheight, temp 
ggplot(alg_hh_wvht, aes(x=date_time)) +
  geom_point(aes(y=temp_c), size=1) +
  geom_point(aes(y=wvht), size=0.5)

#consider tides, time of day...
lol_hh_wvht_tide <- lol_hh_wvht %>%
  mutate(time_lub=hms(time)) %>% #apply lubridate to time
  filter(tide_height>=-0.5, #remove tides I know are too low
         tide_height<=1.5) %>% #remove tides I know are too high
  filter(hour(time_lub)>04, #remove times before sunrise
         #hour(time_lub)>09, #only look at hottest part of day...
         #hour(time_lub)<17, #only look at hottest part of day...
         hour(time_lub)<21) %>% #remove times after sunset
  mutate(tod=ifelse(hour(time_lub)>09 & hour(time_lub)<17, "midday", "cooler"))

#plot up waveheight and temp
ggplot(lol_hh_wvht_tide, aes(x=date_time)) +
  geom_point(aes(y=temp_c, color=tod), size=1) +
  geom_point(aes(y=wvht, color=tod), size=0.5)
 
#plot up wvht against tide height 
ggplot(lol_hh_wvht_tide, aes(x=wvht, y=tide_height)) +
  geom_point(aes(color=tod))
```

No 3C drops at Alegria - not surprising, since sensor was never disconnected from ocean?
